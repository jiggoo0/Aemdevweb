/* global process, console */
/**
 * [BUILD SCRIPT]: IMAGE_BLUR_GEN_ENGINE v18.0.0 (TERMUX_HARDENED)
 * [STRATEGY]: Memory-Aware Sequential Processing | WebP Buffering | Zero-CLS Strategy
 * [MAINTAINER]: AEMZA MACKS (Lead Architect)
 */

import sharp from "sharp";
import { writeFileSync, readdirSync, lstatSync, existsSync, mkdirSync } from "fs";
import { join, relative, dirname, posix } from "path";

// --- [CONFIGURATIONS] ---
const ROOT = process.cwd();
const IMG_DIR = join(ROOT, "public/images");
const OUTPUT_FILE = join(ROOT, "constants/image-blur-data.ts");
const EXCLUDED_DIRS = ["temp", "unused", ".DS_Store", "og-"]; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Blur ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ OG

// [01] INFRASTRUCTURE SETUP
sharp.cache(false); // [CRITICAL]: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô RAM ‡∏£‡∏±‡πà‡∏ß‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° Mobile Dev
const registry = {};
let processedCount = 0;
let errorCount = 0;

/**
 * @function crawlDirectory
 * @description ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Recursive ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÅ‡∏ö‡∏ö Real-time
 */
async function crawlDirectory(dir) {
  const files = readdirSync(dir);

  for (const file of files) {
    const fullPath = join(dir, file);
    const relPathFromBase = relative(IMG_DIR, fullPath);

    if (lstatSync(fullPath).isDirectory()) {
      if (EXCLUDED_DIRS.some((ex) => relPathFromBase.includes(ex))) continue;
      await crawlDirectory(fullPath);
    } else if (/\.(jpg|jpeg|png|webp|avif)$/i.test(file)) {
      // [PATH_NORMALIZATION]: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Next.js (Force Posix)
      const relativeFromPublic = relative(join(ROOT, "public"), fullPath);
      const publicPath = "/" + relativeFromPublic.split("\\").join("/");

      try {
        const image = sharp(fullPath);
        const metadata = await image.metadata();

        /**
         * [FIDELITY]:
         * 10px + Quality 20% = Blur ‡∏à‡∏¥‡πã‡∏ß‡πÅ‡∏ï‡πà‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 150-300 bytes)
         * ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
         */
        const buffer = await image
          .resize(10, null, {
            kernel: sharp.kernel.lanczos3,
            withoutEnlargement: true,
          })
          .webp({ quality: 20, effort: 6 }) // effort 6 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î
          .toBuffer();

        registry[publicPath] = {
          blurDataURL: `data:image/webp;base64,${buffer.toString("base64")}`,
          width: metadata.width || 1200, // Fallback ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
          height: metadata.height || 630,
        };

        processedCount++;
        console.log(`‚úÖ [NODE_${processedCount.toString().padStart(3, "0")}] Baked: ${publicPath}`);
      } catch (err) {
        errorCount++;
        console.error(`‚ùå [ERROR] Failed to process ${publicPath}:`, err.message);
      }
    }
  }
}

// [02] EXECUTION FLOW
console.log("\n--- [AEMDEVWEB] HIGH-FIDELITY BLUR ENGINE STARTING ---");
const startTime = Date.now();

try {
  if (!existsSync(IMG_DIR)) throw new Error(`Directory ${IMG_DIR} not found.`);

  await crawlDirectory(IMG_DIR);

  const outDir = dirname(OUTPUT_FILE);
  if (!existsSync(outDir)) mkdirSync(outDir, { recursive: true });

  const content = `/**
 * [SYSTEM GENERATED]: IMAGE_BLUR_REGISTRY v${new Date().toISOString()}
 * [MANDATE]: Strictly Auto-Generated by scripts/gen-blur-data.mjs.
 * [STRATEGY]: Static BlurHash for Zero-CLS LCP.
 */
import type { ImageBlurRegistry } from "@/types";

export const IMAGE_BLUR_DATA: ImageBlurRegistry = ${JSON.stringify(registry, null, 2)} as const;
`;

  writeFileSync(OUTPUT_FILE, content);

  const duration = ((Date.now() - startTime) / 1000).toFixed(2);
  console.log(`
--- [COMPLETED SUCCESSFULLY] ---
üì¶ Nodes Processed: ${processedCount}
‚ö†Ô∏è Failures: ${errorCount}
‚è±Ô∏è Duration: ${duration}s
üöÄ Registry Updated: constants/image-blur-data.ts
--------------------------------\n`);
} catch (error) {
  console.error("\n--- [CRITICAL SYSTEM ERROR] ---");
  console.error(error.message);
  process.exit(1);
}
