/* global process, console */
/**
 * [BUILD SCRIPT]: IMAGE_BLUR_GEN_ENGINE v17.9.9
 * [STRATEGY]: Recursive Buffer Projection | WebP Compression | Low-Overhead LCH
 * [MAINTAINER]: AEMDEVWEB Specialist Team
 */

import sharp from "sharp";
import { writeFileSync, readdirSync, lstatSync, existsSync, mkdirSync } from "fs";
import { join, relative, dirname } from "path";

// --- [CONFIGURATIONS] ---
const IMG_DIR = "./public/images";
const OUTPUT_FILE = "./constants/image-blur-data.ts";
const EXCLUDED_DIRS = ["temp", "unused", ".DS_Store"];

// [01] INFRASTRUCTURE SETUP
const registry = {};
let processedCount = 0;
let errorCount = 0;

/**
 * @function crawlDirectory
 * @description ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Recursive ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° Termux
 */
async function crawlDirectory(dir) {
  const files = readdirSync(dir);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö Sequential ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î RAM (Critical for Mobile/Android Dev)
  for (const file of files) {
    const fullPath = join(dir, file);
    const relPathFromBase = relative(IMG_DIR, fullPath);

    if (lstatSync(fullPath).isDirectory()) {
      if (EXCLUDED_DIRS.some((ex) => relPathFromBase.includes(ex))) continue;
      await crawlDirectory(fullPath);
    } else if (/\.(jpg|jpeg|png|webp|avif)$/i.test(file)) {
      // ‡πÅ‡∏õ‡∏•‡∏á Path ‡πÄ‡∏õ‡πá‡∏ô Public URL ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Next.js
      const publicPath = "/" + relative("./public", fullPath).split("\\").join("/");

      try {
        const image = sharp(fullPath);
        const metadata = await image.metadata();

        /**
         * [FIDELITY]:
         * ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô 10px ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 20% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Blur Data ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏¥‡πã‡∏ß (‡∏´‡∏•‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢ Bytes)
         * ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (LCP Performance Optimization)
         */
        const buffer = await image
          .resize(10, null, { kernel: "lanczos3" })
          .webp({ quality: 20 })
          .toBuffer();

        registry[publicPath] = {
          blurDataURL: `data:image/webp;base64,${buffer.toString("base64")}`,
          width: metadata.width || 0,
          height: metadata.height || 0,
        };

        processedCount++;
        console.log(`‚úÖ [NODE_${processedCount.toString().padStart(3, "0")}] Baked: ${publicPath}`);
      } catch (err) {
        errorCount++;
        console.error(`‚ùå [ERROR] Failed to process ${publicPath}:`, err.message);
      }
    }
  }
}

// [02] EXECUTION FLOW
console.log("\n--- [AEMDEVWEB] HIGH-FIDELITY BLUR ENGINE STARTING ---");
const startTime = Date.now();

try {
  if (!existsSync(IMG_DIR)) {
    throw new Error(`Directory ${IMG_DIR} not found.`);
  }

  await crawlDirectory(IMG_DIR);

  const outDir = dirname(OUTPUT_FILE);
  if (!existsSync(outDir)) mkdirSync(outDir, { recursive: true });

  const content = `/**
 * [SYSTEM GENERATED]: IMAGE_BLUR_REGISTRY v${new Date().toISOString()}
 * [MANDATE]: Strictly Auto-Generated by scripts/gen-blur-data.mjs. Do not modify.
 * [MAINTAINER]: AEMDEVWEB Specialist Team
 */
import type { ImageBlurRegistry } from "@/types";

export const IMAGE_BLUR_DATA: ImageBlurRegistry = ${JSON.stringify(registry, null, 2)} as const;
`;

  writeFileSync(OUTPUT_FILE, content);

  const duration = ((Date.now() - startTime) / 1000).toFixed(2);
  console.log(`
--- [COMPLETED SUCCESSFULLY] ---
üì¶ Total Processed: ${processedCount} nodes
‚ö†Ô∏è Total Errors: ${errorCount}
‚è±Ô∏è Time Elapsed: ${duration}s
üöÄ Output: ${OUTPUT_FILE}
--------------------------------\n`);
} catch (error) {
  console.error("\n--- [CRITICAL SYSTEM ERROR] ---");
  console.error(error.message);
  process.exit(1); // [RESOLVED]: ESLint ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á Error ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ Global ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
}
